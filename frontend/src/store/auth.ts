import { create } from "zustand";
import { persist } from "zustand/middleware";

/**
 * ğŸ” ì „ì—­ ì¸ì¦ ìƒíƒœ Store (useAuth)
 * â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
 * ëª©ì 
 *  - ì•± ì–´ë””ì„œë‚˜ "ë¡œê·¸ì¸ ì—¬ë¶€ + ì‚¬ìš©ì ì •ë³´ + í† í°"ì„ ì½ê³ /ë°”ê¾¸ê¸° ìœ„í•œ ì „ì—­ ì €ì¥ì†Œì…ë‹ˆë‹¤.
 *  - Zustandë¥¼ ì‚¬ìš©í•˜ë©°, `persist` ë¯¸ë“¤ì›¨ì–´ë¡œ ë¸Œë¼ìš°ì € ì €ì¥ì†Œ(localStorage)ì— ìë™ ì €ì¥í•©ë‹ˆë‹¤.
 *    â†’ ìƒˆë¡œê³ ì¹¨/ì¬ì ‘ì†ì„ í•´ë„ ë¡œê·¸ì¸ ìƒíƒœë¥¼ ìœ ì§€í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
 *
 * êµ¬ì„± ìš”ì†Œ í•œëˆˆì— ë³´ê¸°
 *  - User íƒ€ì…     : ì‚¬ìš©ì í”„ë¡œí•„(ì•„ì´ë””, ì´ë¦„, ì´ë©”ì¼)
 *  - AuthState íƒ€ì…: ë¡œê·¸ì¸ ì—¬ë¶€, ì‚¬ìš©ì/í† í°, login()/logout() í•¨ìˆ˜
 *  - useAuth Store : ì‹¤ì œ ì „ì—­ ìƒíƒœ. ì»´í¬ë„ŒíŠ¸ì—ì„œ `useAuth((s)=>s.isLoggedIn)`ì²˜ëŸ¼ êµ¬ë…í•´ ì‚¬ìš©
 *
 * âš ï¸ ë³´ì•ˆ ë©”ëª¨(ì‹¤ì„œë¹„ìŠ¤ ì „ í™•ì¸)
 *  - localStorageëŠ” ìë°”ìŠ¤í¬ë¦½íŠ¸ë¡œ ì ‘ê·¼ ê°€ëŠ¥í•œ ì˜ì—­ì…ë‹ˆë‹¤. XSS ì·¨ì•½ì ì´ ìˆìœ¼ë©´ í† í°ì´ ìœ ì¶œë  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
 *  - ê°€ëŠ¥í•˜ë‹¤ë©´ ë¯¼ê° í† í°ì€ httpOnly ì¿ í‚¤(ì„œë²„ ì„¸ì…˜)ë¡œ ê´€ë¦¬í•˜ê³ , ì—¬ê¸°ì—ëŠ” ìµœì†Œ ì •ë³´ë§Œ ë³´ê´€í•˜ëŠ” ê²ƒì„ ê¶Œì¥í•©ë‹ˆë‹¤.
 *  - ì´ ì½”ë“œëŠ” ë°ëª¨/í”„ë¡ íŠ¸ ìƒíƒœê´€ë¦¬ ìš©ë„ì´ë©°, ì‹¤ì œ ì¸ì¦ ì—°ë™ ì‹œ ë°±ì—”ë“œ ì •ì±…ì— ë§ì¶° ë³€ê²½í•˜ì„¸ìš”.
 */

// â–¸ ì‚¬ìš©ì ì •ë³´ í˜•íƒœ(ì•„ì´ë””/ì´ë¦„/ì´ë©”ì¼)
export type User = {
  id: string;
  name: string;
  email: string;
};

// â–¸ ì „ì—­ ì¸ì¦ ìƒíƒœì™€ ë©”ì„œë“œ ì •ì˜
export type AuthState = {
  /** í˜„ì¬ ë¡œê·¸ì¸ ì—¬ë¶€ (true/false) */
  isLoggedIn: boolean;
  /** ë¡œê·¸ì¸í•œ ì‚¬ìš©ì ì •ë³´ (ì—†ìœ¼ë©´ null) */
  user: User | null;
  /** ì•¡ì„¸ìŠ¤ í† í°(JWT ë“±). ë°ëª¨ì—ì„œëŠ” ë¬¸ìì—´ë¡œë§Œ ê´€ë¦¬ */
  token: string | null;

  /**
   * ë¡œê·¸ì¸ ì²˜ë¦¬ í•¨ìˆ˜
   * - ì‹¤ì œë¡œëŠ” ì„œë²„ ë¡œê·¸ì¸ API í˜¸ì¶œ í›„ ë°›ì€ { user, token }ì„ ë„£ì–´ì•¼ í•©ë‹ˆë‹¤.
   * - ì—¬ê¸°ì„œëŠ” ì „ë‹¬ë°›ì€ ê°’ì„ ê·¸ëŒ€ë¡œ ì €ì¥í•©ë‹ˆë‹¤.
   */
  login: (payload: { user: User; token: string }) => void;

  /** ë¡œê·¸ì•„ì›ƒ ì²˜ë¦¬ í•¨ìˆ˜: ìƒíƒœ/í† í°/ì‚¬ìš©ì ì •ë³´ë¥¼ ëª¨ë‘ ì´ˆê¸°í™” */
  logout: () => void;
};

/**
 * useAuth: ì „ì—­ ì¸ì¦ ìƒíƒœ í›…
 *  - `persist` ë¯¸ë“¤ì›¨ì–´ë¡œ localStorageì— ìë™ ì €ì¥ë©ë‹ˆë‹¤.
 *  - ì €ì¥ í‚¤(name)ëŠ” "auth-storage"ì…ë‹ˆë‹¤.
 *  - ì»´í¬ë„ŒíŠ¸ ì˜ˆì‹œ:
 *      const isLoggedIn = useAuth((s) => s.isLoggedIn);
 *      const login = useAuth((s) => s.login);
 *      const logout = useAuth((s) => s.logout);
 */
export const useAuth = create<AuthState>()(
  persist(
    (set) => ({
      // ì´ˆê¸° ìƒíƒœê°’(ì•± ì²« ì‹¤í–‰ ì‹œ)
      isLoggedIn: false,
      user: null,
      token: null,

      // â–¸ ë¡œê·¸ì¸: ì „ë‹¬ë°›ì€ ì‚¬ìš©ì/í† í°ì„ ì €ì¥í•˜ê³  isLoggedIn=trueë¡œ ì „í™˜
      //   - ì‹¤ì œ êµ¬í˜„ì—ì„œëŠ” ì„œë²„ ì‘ë‹µê°’ì„ ê·¸ëŒ€ë¡œ ë„£ì–´ì£¼ì„¸ìš”.
      login: ({ user, token }) =>
        set({
          isLoggedIn: true,
          user,
          token,
        }),

      // â–¸ ë¡œê·¸ì•„ì›ƒ: ëª¨ë“  ì¸ì¦ ê´€ë ¨ ìƒíƒœë¥¼ ë¹„ì›ë‹ˆë‹¤.
      logout: () =>
        set({
          isLoggedIn: false,
          user: null,
          token: null,
        }),
    }),
    {
      // â–¸ ë¸Œë¼ìš°ì € ì €ì¥ í‚¤ (DevTools Application â†’ Local Storageì—ì„œ í™•ì¸ ê°€ëŠ¥)
      name: "auth-storage",
      // ì°¸ê³ : ê¸°ë³¸ê°’ìœ¼ë¡œ localStorage ì‚¬ìš©. sessionStorage ë“±ìœ¼ë¡œ ë°”ê¾¸ë ¤ë©´ getStorage ì˜µì…˜ ì‚¬ìš© ê°€ëŠ¥
      // getStorage: () => sessionStorage,
    }
  )
);

/*
 * â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
 * ì‚¬ìš© ì˜ˆì‹œ(ê°œë°œì ì°¸ê³ )
 *
 * // ë¡œê·¸ì¸ ì„±ê³µ ì‹œ(ì˜ˆ: SignupModal onSuccessì—ì„œ):
 * useAuth.getState().login({
 *   user: { id: "u1", name: "ê¹€ë¯¸ì†Œ", email: "miso@example.com" },
 *   token: "FAKE_JWT_TOKEN",
 * });
 *
 * // ë¡œê·¸ì•„ì›ƒ ë²„íŠ¼ í´ë¦­ ì‹œ:
 * useAuth.getState().logout();
 *
 * // í—¤ë”ì—ì„œ ë¡œê·¸ì¸ ìƒíƒœ/ì´ë©”ì¼ í‘œì‹œ:
 * const { isLoggedIn, user } = useAuth();
 *
 * // ë³´í˜¸ ë¼ìš°íŠ¸(ProtectedRoute)ì—ì„œì˜ ì‚¬ìš©:
 * const authed = useAuth.getState().isLoggedIn;
 */