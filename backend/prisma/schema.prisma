datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

/**
 * ───────────────────────────────
 * USER
 * ────────────────────────────────
 */
model User {
  id           Int      @id @default(autoincrement())
  email        String   @unique
  name         String?
  passwordHash String
  role         String?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // 내가 작성한 TasteRecord
  tasteRecords TasteRecord[]

  // 내가 만든 길드
  guilds Guild[]

  // 내가 가입한 길드
  guildMemberships GuildMembership[]

  // 위치 기반 기능
  stays           Stay[]             // 유저가 머물렀던 장소들
  recommendations Recommendation[]   // 유저에게 추천된 장소들
  liveLocation    LiveLocation?      // 현재 위치 (있을 수도 있고 없을 수도)
}

/**
 * ───────────────────────────────
 * TASTE RECORD
 * ────────────────────────────────
 */
model TasteRecord {
  id     String @id @default(cuid())
  userId Int
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  title      String
  desc       String?   // caption
  content    String?   // 상세 내용
  recordedAt DateTime?
  category   String
  tagsJson   String?

  thumb     String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId, createdAt])
}

/**
 * ───────────────────────────────
 * ENUMS
 * ────────────────────────────────
 */
enum GuildMembershipStatus {
  PENDING
  APPROVED
}

/**
 * ───────────────────────────────
 * GUILD MEMBERSHIP
 * ────────────────────────────────
 */
model GuildMembership {
  id        Int                   @id @default(autoincrement())
  userId    Int
  guildId   Int
  status    GuildMembershipStatus @default(APPROVED)
  createdAt DateTime              @default(now())

  guild Guild @relation(fields: [guildId], references: [id])
  user  User  @relation(fields: [userId], references: [id])

  @@unique([userId, guildId])
}

/**
 * ───────────────────────────────
 * GUILD
 * ────────────────────────────────
 */
model Guild {
  id          Int     @id @default(autoincrement())
  name        String
  description String?
  category    String?
  tagsJson    String?
  rules       String?
  maxMembers  Int     @default(20)
  emblemUrl   String?

  ownerId Int
  owner   User @relation(fields: [ownerId], references: [id])

  memberships GuildMembership[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([createdAt])
}

/**
 * ───────────────────────────────
 * STAY (사용자가 머물렀던 장소)
 * ────────────────────────────────
 */
model Stay {
  id        Int      @id @default(autoincrement())

  userId    Int
  user      User     @relation(fields: [userId], references: [id])

  lat       Float
  lng       Float
  startTime DateTime
  endTime   DateTime

  // 카카오 장소 + 카테고리 정보
  kakaoPlaceId      String?
  categoryName      String?
  categoryGroupCode String?
  mappedCategory    String?   // '영화' | '공연' | ...

  createdAt DateTime @default(now())

  @@index([userId, startTime])
  @@index([userId, mappedCategory])

  recommendations Recommendation[]
}

/**
 * ───────────────────────────────
 * RECOMMENDATION (개인 추천)
 * ────────────────────────────────
 */
model Recommendation {
  id        Int      @id @default(autoincrement())

  userId    Int
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  // stay는 옵션 (없어도 됨) : 방문한 뒤에 붙여줄 수 있음
  stayId    Int?
  stay      Stay?    @relation(fields: [stayId], references: [id], onDelete: Cascade)

  kakaoPlaceId      String
  name              String
  categoryName      String?
  categoryGroupCode String?
  mappedCategory    String   // '영화' | '공연' | ...

  x         Float   // 경도
  y         Float   // 위도
  score     Float   // 취향 가중치 점수

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([userId, kakaoPlaceId, stayId])
  @@index([userId, score])
}

/**
 * ───────────────────────────────
 * LIVE LOCATION (실시간 위치)
 * ────────────────────────────────
 */
model LiveLocation {
  id       Int      @id @default(autoincrement())

  userId   Int      @unique
  user     User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  lat      Float
  lng      Float
  updatedAt DateTime @updatedAt

  @@index([updatedAt])
}
