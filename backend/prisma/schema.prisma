datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

/**
 * ───────────────────────────────
 * USER
 * ────────────────────────────────
 */
model User {
  id           Int      @id @default(autoincrement())
  email        String   @unique
  name         String?
  passwordHash String
  role         String?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // 내가 작성한 TasteRecord
  tasteRecords TasteRecord[]

  // 내가 만든 길드 (Guild.owner 와 연결)
  guilds Guild[]

  // 내가 가입한 길드 (Membership 기반)
  guildMemberships GuildMembership[]
}

/**
 * ───────────────────────────────
 * TASTE RECORD
 * ────────────────────────────────
 */
model TasteRecord {
  id     String @id @default(cuid())
  userId Int
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  title    String
  desc     String?
  content  String?
  category String
  tagsJson String?

  thumb     String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId, createdAt])
}

/**
 * ───────────────────────────────
 * ENUMS
 * ────────────────────────────────
 */
enum GuildMembershipStatus {
  PENDING
  APPROVED
}

/**
 * ───────────────────────────────
 * GUILD MEMBERSHIP (조인 테이블)
 * ────────────────────────────────
 */
model GuildMembership {
  id        Int                   @id @default(autoincrement())
  userId    Int
  guildId   Int
  status    GuildMembershipStatus @default(APPROVED)
  createdAt DateTime              @default(now())

  // 관계 설정
  guild Guild @relation(fields: [guildId], references: [id])
  user  User  @relation(fields: [userId], references: [id])

  // 같은 길드 중복 가입 방지
  @@unique([userId, guildId])
}

/**
 * ───────────────────────────────
 * GUILD
 * ────────────────────────────────
 */
model Guild {
  id          Int     @id @default(autoincrement())
  name        String
  description String?
  category    String?
  tagsJson    String?
  rules       String?
  maxMembers  Int     @default(20)
  emblemUrl   String?

  ownerId Int
  owner   User @relation(fields: [ownerId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Membership의 반대편 (중요!)
  memberships GuildMembership[]

  @@index([createdAt])
}
