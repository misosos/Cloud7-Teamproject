datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

/**
 * ───────────────────────────────
 * USER
 * ────────────────────────────────
 */
model User {
  id           Int      @id @default(autoincrement())
  email        String   @unique
  name         String?
  passwordHash String
  role         String?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  tasteRecords TasteRecord[]

  guilds            Guild[]
  guildMemberships  GuildMembership[]

  // 위치 기반 기능
  stays           Stay[]             // 유저가 머물렀던 장소들
  recommendations Recommendation[]   // 유저에게 추천된 장소들
  liveLocation    LiveLocation?     // ✅ 현재 위치 (1:1)

  // 길드 도감 기록
  guildRecords GuildRecord[]
  
  // 길드 점수
  guildScores GuildScore[]

  // 길드 도감 댓글
  guildRecordComments GuildRecordComment[]

  // 받은 알림
  notifications Notification[] @relation("NotificationToUser")

  // 보낸 알림
  sentNotifications Notification[] @relation("NotificationFromUser")
}

/**
 * ───────────────────────────────
 * TASTE RECORD
 * ────────────────────────────────
 */
model TasteRecord {
  id     String @id @default(cuid())
  userId Int
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  title      String
  desc       String?
  content    String?
  recordedAt DateTime?
  category   String
  tagsJson   String?

  thumb     String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId, createdAt])
}

/**
 * ───────────────────────────────
 * ENUMS
 * ────────────────────────────────
 */
enum GuildMembershipStatus {
  PENDING
  APPROVED
}

/**
 * ───────────────────────────────
 * GUILD MEMBERSHIP (조인 테이블)
 * ────────────────────────────────
 */
model GuildMembership {
  id        Int                   @id @default(autoincrement())
  userId    Int
  guildId   Int
  status    GuildMembershipStatus @default(APPROVED)
  createdAt DateTime              @default(now())

  guild Guild @relation(fields: [guildId], references: [id])
  user  User  @relation(fields: [userId], references: [id])

  @@unique([userId, guildId])
}

/**
 * ───────────────────────────────
 * GUILD
 * ────────────────────────────────
 */
model Guild {
  id          Int     @id @default(autoincrement())
  name        String
  description String?
  category    String?
  tagsJson    String?
  rules       String?
  maxMembers  Int     @default(20)
  emblemUrl   String?

  ownerId Int
  owner   User @relation(fields: [ownerId], references: [id])

  memberships     GuildMembership[]
  recommendations Recommendation[]   // ✅ 길드 추천 (옵션)

  // 길드 도감 기록
  guildRecords GuildRecord[]

  // 길드 미션
  missions GuildMission[]

  // 길드 점수
  guildScores GuildScore[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([createdAt])
}

/**
 * ───────────────────────────────
 * STAY (사용자가 머물렀던 장소)
 * ────────────────────────────────
 */
model Stay {
  id        Int      @id @default(autoincrement())

  userId    Int
  user      User     @relation(fields: [userId], references: [id])

  lat       Float
  lng       Float
  startTime DateTime
  endTime   DateTime

  kakaoPlaceId      String?
  categoryName      String?
  categoryGroupCode String?
  mappedCategory    String?

  // 추천 장소 달성 시 점수 지급 여부 (중복 방지)
  recommendationPointsAwardedAt DateTime?

  createdAt DateTime @default(now())

  @@index([userId, startTime])
  @@index([userId, mappedCategory])

  recommendations Recommendation[]
}

/**
 * ───────────────────────────────
 * LIVE LOCATION (실시간 위치)
 * ────────────────────────────────
 */
model LiveLocation {
  userId    Int      @id
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  lat       Float?
  lng       Float?

  updatedAt DateTime @updatedAt
  createdAt DateTime @default(now())
}

/**
 * ───────────────────────────────
 * RECOMMENDATION (장소 추천)
 * ────────────────────────────────
 */
model Recommendation {
  id        Int      @id @default(autoincrement())

  // 개인 추천
  userId    Int
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  // 연맹 추천
  guildId   Int?
  guild     Guild?   @relation(fields: [guildId], references: [id])

  // PERSONAL | GUILD
  source    String   @default("PERSONAL")

  // stay는 옵션 (없어도 됨)
  stayId    Int?
  stay      Stay?    @relation(fields: [stayId], references: [id], onDelete: Cascade)

  kakaoPlaceId      String
  name              String
  categoryName      String?
  categoryGroupCode String?
  mappedCategory    String   // '영화' | '공연' | ... | '식당'

  x         Float
  y         Float
  distanceMeters Float?      // ✅ 현재 위치로부터 거리(m)

  score     Float

  roadAddress       String?
  address           String?
  phone             String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([userId, kakaoPlaceId, stayId])
  @@index([userId, score])
}

/**
 * ───────────────────────────────
 * GUILD MISSION (연맹 미션)
 * ────────────────────────────────
 */
model GuildMission {
  id     String @id @default(cuid())
  guildId Int
  guild   Guild @relation(fields: [guildId], references: [id], onDelete: Cascade)

  title      String
  content    String?   // 미션 설명
  limitCount Int       // 선착순 인원
  difficulty String?   // 난이도 (선택형)
  mainImage  String?   // 대표 이미지 URL
  extraImagesJson String? // 추가 이미지 배열을 JSON 문자열로 저장

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // 이 미션에 대한 참여 기록들
  records GuildRecord[]

  @@index([guildId, createdAt])
}

/**
 * ───────────────────────────────
 * GUILD RECORD (연맹 도감 기록)
 * ────────────────────────────────
 */
model GuildRecord {
  id     String @id @default(cuid())
  guildId Int
  guild   Guild @relation(fields: [guildId], references: [id], onDelete: Cascade)
  
  userId Int
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // 미션 참여 기록인 경우 missionId가 있음
  missionId String?
  mission   GuildMission? @relation(fields: [missionId], references: [id], onDelete: SetNull)

  title      String
  desc       String?   // 한 줄 설명
  content    String?   // 상세 내용
  category   String?
  recordedAt DateTime? // 사용자가 선택하는 날짜
  rating     Int?      // 별점 (1-5)
  mainImage  String?   // 메인 이미지 URL
  extraImagesJson String? // 추가 이미지 배열을 JSON 문자열로 저장
  hashtagsJson   String? // 해시태그 배열을 JSON 문자열로 저장

  // 추천 장소 달성 기록인 경우 kakaoPlaceId가 있음
  kakaoPlaceId String? // 추천 장소 달성 기록인 경우 카카오 장소 ID

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // 댓글
  comments GuildRecordComment[]

  @@index([guildId, createdAt])
  @@index([userId, createdAt])
  @@index([missionId, createdAt])
}

/**
 * ───────────────────────────────
 * GUILD SCORE (연맹 점수)
 * ────────────────────────────────
 */
model GuildScore {
  id        Int      @id @default(autoincrement())
  userId    Int
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  guildId   Int
  guild     Guild    @relation(fields: [guildId], references: [id], onDelete: Cascade)
  score     Int      @default(0)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([userId, guildId])
  @@index([guildId, score])
}

/**
 * ───────────────────────────────
 * GUILD RECORD COMMENT (연맹 도감 댓글)
 * ────────────────────────────────
 */
model GuildRecordComment {
  id     String @id @default(cuid())
  recordId String
  record   GuildRecord @relation(fields: [recordId], references: [id], onDelete: Cascade)
  
  userId Int
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  parentCommentId String?
  parentComment   GuildRecordComment? @relation("CommentReplies", fields: [parentCommentId], references: [id], onDelete: Cascade)
  replies         GuildRecordComment[] @relation("CommentReplies")

  content   String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([recordId, createdAt])
  @@index([userId, createdAt])
  @@index([parentCommentId])
}

/**
 * ───────────────────────────────
 * NOTIFICATION (알림)
 * ────────────────────────────────
 */
model Notification {
  id     String @id @default(cuid())
  userId Int
  user   User   @relation("NotificationToUser", fields: [userId], references: [id], onDelete: Cascade)
  
  fromUserId Int
  fromUser   User @relation("NotificationFromUser", fields: [fromUserId], references: [id], onDelete: Cascade)

  type      String   // "COMMENT" | "REPLY" 등
  recordId  String?  // 관련 도감 기록 ID
  commentId String?  // 관련 댓글 ID
  content   String?  // 알림 내용

  isRead    Boolean  @default(false)
  createdAt DateTime @default(now())

  @@index([userId, isRead, createdAt])
  @@index([userId, createdAt])
}
