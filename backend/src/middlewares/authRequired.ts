/// <reference path="../types/session.d.ts" />
// src/middlewares/authRequired.ts
import type { Request, Response, NextFunction } from 'express';
import type { SessionUser } from '../types/session';

/**
 * â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
 *  ë¡œê·¸ì¸ ë³´í˜¸ ë¯¸ë“¤ì›¨ì–´ (ì„¸ì…˜ ì¿ í‚¤ ê¸°ë°˜)
 * â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
 * ì´ ë¯¸ë“¤ì›¨ì–´ëŠ” **ì„¸ì…˜(Session) ì¿ í‚¤**ë¥¼ ì´ìš©í•´ ë¡œê·¸ì¸ ì—¬ë¶€ë¥¼ íŒë³„í•©ë‹ˆë‹¤.
 *
 * [ë™ì‘ ê°œìš”]
 * - ì„œë²„ì—ì„œ ë¡œê·¸ì¸ ì„±ê³µ ì‹œ ì»¨íŠ¸ë¡¤ëŸ¬ì—ì„œ
 *     `req.session.user = { id, email, name?, role? }`
 *   í˜•íƒœë¡œ ìµœì†Œ ì‚¬ìš©ì ì •ë³´ë¥¼ ì €ì¥í•©ë‹ˆë‹¤.
 * - ë³´í˜¸ê°€ í•„ìš”í•œ ë¼ìš°íŠ¸ì—ì„œ ì´ ë¯¸ë“¤ì›¨ì–´ë¥¼ ì‚¬ìš©í•˜ë©´,
 *   ì„¸ì…˜ì— ì‚¬ìš©ì ì •ë³´ê°€ ìˆëŠ”ì§€ ê²€ì‚¬í•©ë‹ˆë‹¤.
 * - í†µê³¼í•œ ê²½ìš° `req.currentUser`ì— ë™ì¼í•œ ê°ì²´ë¥¼ ì£¼ì…í•˜ì—¬
 *   ì´í›„ í•¸ë“¤ëŸ¬ì—ì„œ í¸í•˜ê²Œ ì“¸ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
 *
 * [í”„ë¡ íŠ¸ì—”ë“œ ì—°ë™ ê·œì¹™]
 * - ì•± ë¶€íŒ…:  `/auth/me` í˜¸ì¶œ
 *   - ì‘ë‹µ 200 + user ìˆìœ¼ë©´ â†’ ë¡œê·¸ì¸ ìƒíƒœë¡œ ì„¸íŒ…
 *   - ì‘ë‹µ 200 + user nullì´ë©´ â†’ ë¹„ë¡œê·¸ì¸ ìƒíƒœë¡œ ì„¸íŒ…
 * - ë¡œê·¸ì¸:  `/auth/login` ì„±ê³µ ì‹œ
 *   - ì„œë²„ê°€ ì„¸ì…˜ì— user ì €ì¥ â†’ ì´í›„ ìš”ì²­ë¶€í„° ìë™ ì¸ì¦
 * - ë¡œê·¸ì•„ì›ƒ: `/auth/logout` í˜¸ì¶œ ì‹œ
 *   - ì„œë²„ì—ì„œ ì„¸ì…˜ íŒŒê¸° â†’ í”„ë¡ íŠ¸ ìŠ¤í† ì–´ë„ ì´ˆê¸°í™”
 *
 * [ìì£¼ ê²ªëŠ” ì´ìŠˆ]
 * 1) 401ì´ ê³„ì† ë°œìƒí•˜ëŠ” ê²½ìš°
 *    - CORS ì„¤ì •ì—ì„œ `credentials: true` ëˆ„ë½ ì—¬ë¶€ í™•ì¸ (ì„œë²„/í´ë¼ì´ì–¸íŠ¸ ëª¨ë‘)
 *    - ì¿ í‚¤ ì˜µì…˜(`sameSite`, `secure`)ì´ í”„ë¡ íŠ¸/ë°±ì—”ë“œ ë„ë©”ì¸ ì¡°í•©ì— ë§ëŠ”ì§€ í™•ì¸
 *    - í”„ë¡ íŠ¸ fetch/axios ìš”ì²­ì— `withCredentials: true` ì˜µì…˜ì´ ë¹ ì§€ì§€ ì•Šì•˜ëŠ”ì§€ ì²´í¬
 *
 * 2) íƒ€ì… ì˜¤ë¥˜ê°€ ë‚˜ëŠ” ê²½ìš°
 *    - `req.currentUser` íƒ€ì… ì„ ì–¸ì€ `src/types/session.d.ts`ì—ì„œ
 *      **ì„ ì–¸ ë³‘í•©(Declaration Merging)** ìœ¼ë¡œ í™•ì¥í•´ì•¼ í•©ë‹ˆë‹¤.
 *
 * 3) í”„ë¡ì‹œ/ë¦¬ë²„ìŠ¤ í”„ë¡ì‹œ í™˜ê²½
 *    - HTTPS ë° í”„ë¡ì‹œ ì‚¬ìš© ì‹œ `app.set('trust proxy', 1)` ì„¤ì •ì„ ê³ ë ¤í•˜ì„¸ìš”.
 *      (ì¿ í‚¤ì˜ `secure` ì˜µì…˜ ë° `X-Forwarded-*` í—¤ë” ì²˜ë¦¬ì— í•„ìš”í•  ìˆ˜ ìˆìŒ)
 */
export default function authRequired(
  req: Request,
  res: Response,
  next: NextFunction,
) {
  // 1) ì„¸ì…˜ì— ì €ì¥ëœ ì‚¬ìš©ì ì •ë³´ë§Œ ì‹ ë¢°í•©ë‹ˆë‹¤.
  //    - ë¡œê·¸ì¸ ì„±ê³µ ì‹œ ì»¨íŠ¸ë¡¤ëŸ¬ì—ì„œ
  //      `req.session.user = { id, email, name?, role? }` í˜•íƒœë¡œ ì €ì¥í–ˆë‹¤ê³  ê°€ì •í•©ë‹ˆë‹¤.
  const user = req.session?.user;

  // 2) ì„¸ì…˜ì— ì‚¬ìš©ì ì •ë³´ê°€ ì—†ìœ¼ë©´ 401(UNAUTHORIZED) ë°˜í™˜
  if (!user) {
    return res.status(401).json({
      ok: false,
      error: 'UNAUTHORIZED',
      message: 'ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.',
    });
  }

  // 3) í•˜ìœ„ í•¸ë“¤ëŸ¬ í¸ì˜ë¥¼ ìœ„í•´ currentUserì— ì£¼ì…
  //    - íƒ€ì…ì€ session.d.tsì—ì„œ Request ì¸í„°í˜ì´ìŠ¤ë¥¼ í™•ì¥í•˜ì—¬ ì„ ì–¸ë˜ì–´ ìˆì–´ì•¼ í•©ë‹ˆë‹¤.
  req.currentUser = user;

  // 4) ë‹¤ìŒ ë¯¸ë“¤ì›¨ì–´/í•¸ë“¤ëŸ¬ë¡œ ì§„í–‰
  return next();
}

/**
 * â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
 *  ì—­í• (Role) ê¸°ë°˜ ì ‘ê·¼ ì œì–´ ë¯¸ë“¤ì›¨ì–´ (ì„ íƒ ê¸°ëŠ¥)
 * â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
 * íŠ¹ì • ì—­í• (ì˜ˆ: 'admin', 'manager')ì—ê²Œë§Œ í—ˆìš©í•˜ê³  ì‹¶ì„ ë•Œ ì‚¬ìš©í•©ë‹ˆë‹¤.
 *
 * ì‚¬ìš© ì˜ˆ:
 *   router.post(
 *     '/admin-only',
 *     authRequired,
 *     requireRole('admin'),
 *     handler,
 *   );
 *
 * [ë™ì‘ ê·œì¹™]
 * - ë¡œê·¸ì¸ ì—¬ë¶€ í™•ì¸:
 *   - `req.currentUser`ê°€ ìˆìœ¼ë©´ ìš°ì„  ì‚¬ìš©
 *   - ì—†ìœ¼ë©´ `req.session.user`ë¥¼ ë³´ì¡°ë¡œ í™•ì¸
 * - roles ì¸ìê°€ ë¹„ì–´ ìˆìœ¼ë©´:
 *   - ì—­í•  ê²€ì‚¬ë¥¼ í•˜ì§€ ì•Šê³ , ë¡œê·¸ì¸ë§Œ ë˜ì–´ ìˆìœ¼ë©´ í†µê³¼
 * - user.roleì´ ì—†ìœ¼ë©´:
 *   - ë³„ë„ì˜ ì—­í•  ì •ë³´ê°€ ì—†ëŠ” ìƒíƒœì´ë¯€ë¡œ, ì—­í•  ê²€ì‚¬ëŠ” ìŠ¤í‚µ
 *   - ì¦‰, "ë¡œê·¸ì¸ ì‚¬ìš©ìë©´ ëª¨ë‘ í—ˆìš©" íŒ¨í„´ìœ¼ë¡œ ë™ì‘
 * - ì—­í• ì„ ë°˜ë“œì‹œ ê°•ì œí•˜ë ¤ë©´:
 *   - íšŒì› ê°ì²´ ì €ì¥ ì‹œ roleì„ ë°˜ë“œì‹œ ì„¸íŒ…í•´ ì£¼ì„¸ìš”.
 */
export function requireRole(...roles: string[]) {
  return (req: Request, res: Response, next: NextFunction) => {
    // currentUserê°€ ìˆìœ¼ë©´ ìš°ì„  ì‚¬ìš©í•˜ê³ , ì—†ìœ¼ë©´ session.userë¥¼ ë³´ì¡°ë¡œ í™•ì¸
    const user = req.currentUser ?? req.session?.user;

    // ë¡œê·¸ì¸ ìƒíƒœê°€ ì•„ë‹ˆë©´ 401
    if (!user) {
      return res.status(401).json({ ok: false, error: 'UNAUTHORIZED' });
    }

    // ğŸ”§ rolesê°€ ë¹„ì–´ ìˆìœ¼ë©´ ì—­í•  ê²€ì‚¬ëŠ” ìŠ¤í‚µ (ë¡œê·¸ì¸ë§Œ ë˜ì—ˆìœ¼ë©´ í†µê³¼)
    if (roles.length === 0) return next();

    // user.roleì´ ì¡´ì¬í•  ë•Œë§Œ ì—­í•  ê²€ì‚¬ ìˆ˜í–‰
    if (user.role && !roles.includes(user.role)) {
      return res.status(403).json({ ok: false, error: 'FORBIDDEN' });
    }

    return next();
  };
}

/* =============================================================================
   CORS / ì„¸ì…˜ ì¿ í‚¤ ì„¤ì • ì²´í¬ë¦¬ìŠ¤íŠ¸ (app.ts ì„¤ì • ì˜ˆì‹œ)
   =============================================================================

   1) CORS: ë°˜ë“œì‹œ credentials í—ˆìš© + í”„ë¡ íŠ¸ ë„ë©”ì¸ ì§€ì •
   ---------------------------------------------------------------------------
   app.use(
     cors({
       origin: ENV.CORS_ORIGIN,   // ì˜ˆ: 'http://localhost:5173'
       credentials: true,         // ì¿ í‚¤ ì „ì†¡ í—ˆìš© (í•µì‹¬)
     }),
   );

   2) ì„¸ì…˜/ì¿ í‚¤: sameSite/secure ê°’ì€ ë„ë©”ì¸/í”„ë¡œí† ì½œ ì¡°í•©ì— ë§ì¶° ì¡°ì •
   ---------------------------------------------------------------------------
   app.use(
     session({
       name: 'sid',                       // ì„¸ì…˜ ì¿ í‚¤ ì´ë¦„
       secret: ENV.SESSION_SECRET,        // .envì—ì„œ ê´€ë¦¬
       resave: false,
       saveUninitialized: false,
       cookie: {
         httpOnly: true,                  // XSS ë°©ì§€ (í´ë¼ì´ì–¸íŠ¸ JSì—ì„œ ì ‘ê·¼ ë¶ˆê°€)
         sameSite: 'lax',                 // ì„œë¡œ ë‹¤ë¥¸ ë„ë©”ì¸/í¬íŠ¸ ì¡°í•©ì´ë©´ 'none' + secure í•„ìš”
         secure: ENV.NODE_ENV === 'production', // HTTPSì—ì„œë§Œ ì „ì†¡ (ê°œë°œ í™˜ê²½ì—ì„œëŠ” false)
         maxAge: 1000 * 60 * 60 * 24 * 7,       // 7ì¼
       },
     }),
   );

   3) í”„ë¡ íŠ¸ì—”ë“œ(axios/fetch)ì—ì„œ ë°˜ë“œì‹œ withCredentials/credentials ì„¤ì •
   ---------------------------------------------------------------------------
   // axios ì˜ˆì‹œ:
   //   axios.get('/auth/me', { withCredentials: true });
   //
   // fetch ì˜ˆì‹œ:
   //   fetch('/auth/me', { credentials: 'include' });

   4) Production í™˜ê²½(HTTPS, í”„ë¡ì‹œ)ì—ì„œ ì¶”ê°€ íŒ
   ---------------------------------------------------------------------------
   // - app.set('trust proxy', 1) ì„¤ì • ì‹œ,
   //   secure ì¿ í‚¤ ë° X-Forwarded-* í—¤ë” ì²˜ë¦¬ì— ë„ì›€ì´ ë©ë‹ˆë‹¤.
   // - ì—¬ëŸ¬ ì„œë¸Œë„ë©”ì¸ì—ì„œ ê³µí†µ ì¿ í‚¤ë¥¼ ì“°ê³  ì‹¶ë‹¤ë©´
   //   cookie.domain ì˜µì…˜(ì˜ˆ: '.example.com')ì„ ê³ ë ¤í•˜ì„¸ìš”.
 */ 

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  ë¡œê·¸ì¸ëœ ì‚¬ìš©ì ìš”ì²­ íƒ€ì… (AuthedRequest)
//  - authRequired ë¯¸ë“¤ì›¨ì–´ë¥¼ ì§€ë‚œ í›„ì—ëŠ” req.currentUserê°€ í•­ìƒ ì¡´ì¬í•œë‹¤ê³  ê°€ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
//  - ë¼ìš°íŠ¸ í•¸ë“¤ëŸ¬ì—ì„œ Request ëŒ€ì‹  AuthedRequestë¥¼ ì‚¬ìš©í•˜ë©´ íƒ€ì… ì•ˆì „ì„±ì´ ì˜¬ë¼ê°‘ë‹ˆë‹¤.
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
export type AuthedRequest = Request & {
  currentUser: SessionUser;
};