/// <reference path="../types/session.d.ts" />
// src/middlewares/authRequired.ts
import type { Request, Response, NextFunction } from 'express';

/**
 * â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
 *  ë¡œê·¸ì¸ ë³´í˜¸ ë¯¸ë“¤ì›¨ì–´ (ì„¸ì…˜ ì¿ í‚¤ ê¸°ë°˜)
 * â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
 * ì´ ë¯¸ë“¤ì›¨ì–´ëŠ” **ì„¸ì…˜(Session) ì¿ í‚¤**ë¥¼ ì´ìš©í•´ ë¡œê·¸ì¸ ì—¬ë¶€ë¥¼ íŒë³„í•©ë‹ˆë‹¤.
 * - ì„œë²„ì—ì„œ ë¡œê·¸ì¸ ì„±ê³µ ì‹œ `req.session.user`ì— ìµœì†Œ ì •ë³´(id, email, name?, role?)ë¥¼ ì €ì¥í•©ë‹ˆë‹¤.
 * - ë³´í˜¸ê°€ í•„ìš”í•œ ë¼ìš°íŠ¸ì—ì„œ ì´ ë¯¸ë“¤ì›¨ì–´ë¥¼ ì‚¬ìš©í•˜ë©´, ì„¸ì…˜ì— ì‚¬ìš©ì ì •ë³´ê°€ ìˆëŠ”ì§€ ê²€ì‚¬í•©ë‹ˆë‹¤.
 * - í†µê³¼í•œ ê²½ìš° `req.currentUser`ì—ë„ ë™ì¼í•œ ê°ì²´ë¥¼ ì£¼ì…í•˜ì—¬ ì´í›„ í•¸ë“¤ëŸ¬ì—ì„œ í¸í•˜ê²Œ ì‚¬ìš©í•©ë‹ˆë‹¤.
 *
 * [í”„ë¡œì íŠ¸ ì „ì œ (Aì•ˆ)]
 * - ì´ í”„ë¡œì íŠ¸ëŠ” "ì„¸ì…˜ ì¿ í‚¤ì— userë¥¼ ì €ì¥"í•˜ëŠ” ë°©ì‹(Aì•ˆ)ì„ ê¸°ë³¸ìœ¼ë¡œ ì‚¬ìš©í•©ë‹ˆë‹¤.
 * - ë”°ë¼ì„œ ì¸ì¦ ìƒíƒœ íŒë‹¨ì€ **í•­ìƒ `req.session.user`ë§Œ** ì‹ ë¢°í•©ë‹ˆë‹¤. (ë³´ì•ˆìƒ `req.user`ëŠ” ì‚¬ìš©í•˜ì§€ ì•ŠìŒ)
 *
 * [í”„ë¡ íŠ¸ì—”ë“œ ì—°ë™ ê·œì¹™]
 * - ì•± ë¶€íŒ…:    `/auth/me` í˜¸ì¶œ â†’ 200ì´ë©´ user ì„¸íŒ…, 401ì´ë©´ ë¹„ë¡œê·¸ì¸ ì²˜ë¦¬
 * - ë¡œê·¸ì¸:     `/auth/login` ì„±ê³µ ì‹œ ì„œë²„ê°€ ì„¸ì…˜ì— user ì €ì¥ â†’ ì´í›„ ìš”ì²­ë¶€í„° ìë™ ì¸ì¦
 * - ë¡œê·¸ì•„ì›ƒ:   `/auth/logout` í˜¸ì¶œ ì‹œ ì„¸ì…˜ íŒŒê¸° â†’ í”„ë¡ íŠ¸ ìŠ¤í† ì–´ ì´ˆê¸°í™”
 *
 * [ìì£¼ ê²ªëŠ” ì´ìŠˆ]
 * 1) 401 ê³„ì† ë°œìƒ:
 *    - CORS ì„¤ì •ì—ì„œ `credentials: true`ê°€ ë¹ ì¡ŒëŠ”ì§€ í™•ì¸ (ì„œë²„/í´ë¼ì´ì–¸íŠ¸ ëª¨ë‘)
 *    - `sameSite`/`secure` ì¿ í‚¤ ì„¤ì •ì´ í”„ë¡ íŠ¸/ë°±ì—”ë“œ ë„ë©”ì¸ ì¡°í•©ì— ë§ëŠ”ì§€ í™•ì¸
 *    - í”„ë¡ íŠ¸ fetch/axiosì— `withCredentials: true` ì˜µì…˜ ëˆ„ë½ ì²´í¬
 * 2) íƒ€ì… ì˜¤ë¥˜:
 *    - `req.currentUser` íƒ€ì… ì„ ì–¸ì€ `src/types/session.d.ts`ì—ì„œ **ì„ ì–¸ ë³‘í•©(Declaration Merging)** ìœ¼ë¡œ í™•ì¥í•©ë‹ˆë‹¤.
 * 3) í”„ë¡ì‹œ/ë¦¬ë²„ìŠ¤í”„ë¡ì‹œ:
 *    - HTTPS/í”„ë¡ì‹œ í™˜ê²½ì—ì„œëŠ” `app.set('trust proxy', 1)` ê³ ë ¤ (ì¿ í‚¤ `secure`ì™€ í•¨ê»˜)
 */
export default function authRequired(req: Request, res: Response, next: NextFunction) {
  // 1) ì„¸ì…˜ì— ì €ì¥ëœ ì‚¬ìš©ì ì •ë³´ë§Œ ì‹ ë¢°í•©ë‹ˆë‹¤.
  //    - ë¡œê·¸ì¸ ì„±ê³µ ì‹œ ì»¨íŠ¸ë¡¤ëŸ¬ì—ì„œ `req.session.user = { id, email, name?, role? }` í˜•íƒœë¡œ ì €ì¥í•©ë‹ˆë‹¤.
  const user = req.session?.user;

  // 2) ì„¸ì…˜ì´ ì—†ìœ¼ë©´ 401(UNAUTHORIZED) ë°˜í™˜
  if (!user) {
    return res.status(401).json({
      ok: false,
      error: 'UNAUTHORIZED',
      message: 'ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.',
    });
  }

  // 3) í•˜ìœ„ í•¸ë“¤ëŸ¬ í¸ì˜ë¥¼ ìœ„í•´ currentUserì— ì£¼ì…
  //    - íƒ€ì…ì€ session.d.tsì—ì„œ Request ì¸í„°í˜ì´ìŠ¤ë¥¼ í™•ì¥í•˜ì—¬ ì„ ì–¸ë˜ì–´ ìˆì–´ì•¼ í•©ë‹ˆë‹¤.
  req.currentUser = user;

  // 4) ë‹¤ìŒ ë¯¸ë“¤ì›¨ì–´/í•¸ë“¤ëŸ¬ë¡œ ì§„í–‰
  return next();
}

/**
 * â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
 *  ì—­í•  ê¸°ë°˜ ì ‘ê·¼ ì œì–´ (ì„ íƒ)
 * â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
 * íŠ¹ì • ì—­í• (ì˜ˆ: 'admin', 'manager')ì—ê²Œë§Œ í—ˆìš©í•˜ê³  ì‹¶ì„ ë•Œ ì‚¬ìš©í•©ë‹ˆë‹¤.
 * ì‚¬ìš© ì˜ˆ:
 *   router.post('/admin-only', authRequired, requireRole('admin'), handler);
 *
 * - user.roleì´ ì—†ìœ¼ë©´(ì •ì˜ë˜ì§€ ì•Šìœ¼ë©´) ì—­í•  ê²€ì‚¬ëŠ” ê±´ë„ˆëœë‹ˆë‹¤(=ëª¨ë“  ë¡œê·¸ì¸ ì‚¬ìš© í—ˆìš©).
 * - ì—­í• ì„ ë°˜ë“œì‹œ ê°•ì œí•˜ë ¤ë©´, íšŒì› ê°ì²´ ì €ì¥ ì‹œ roleì„ ëª…í™•íˆ ì„¸íŒ…í•˜ì„¸ìš”.
 */
export function requireRole(...roles: string[]) {
  return (req: Request, res: Response, next: NextFunction) => {
    // currentUserê°€ ìˆìœ¼ë©´ ìš°ì„  ì‚¬ìš©í•˜ê³ , ì—†ìœ¼ë©´ session.userë¥¼ ë³´ì¡°ë¡œ í™•ì¸
    const user = req.currentUser ?? req.session?.user;

    // ë¡œê·¸ì¸ ìƒíƒœê°€ ì•„ë‹ˆë©´ 401
    if (!user) {
      return res.status(401).json({ ok: false, error: 'UNAUTHORIZED' });
    }

    // ğŸ”§ rolesê°€ ë¹„ì–´ìˆìœ¼ë©´ ì—­í•  ê²€ì‚¬ëŠ” ìŠ¤í‚µ (ë¡œê·¸ì¸ë§Œ ë˜ì—ˆìœ¼ë©´ í†µê³¼)
    if (roles.length === 0) return next();

    // user.roleì´ ì¡´ì¬í•  ë•Œë§Œ ì—­í•  ê²€ì‚¬ ìˆ˜í–‰
    if (user.role && !roles.includes(user.role)) {
      return res.status(403).json({ ok: false, error: 'FORBIDDEN' });
    }

    return next();
  };
}

/* =============================================================================
   CORS / ì„¸ì…˜ ì¿ í‚¤ ì²´í¬ë¦¬ìŠ¤íŠ¸ (app.ts ì„¤ì • ì˜ˆì‹œ)
   -----------------------------------------------------------------------------
   // 1) CORS: ë°˜ë“œì‹œ credentials í—ˆìš© ë° í”„ë¡ íŠ¸ ë„ë©”ì¸ ì§€ì •
   app.use(
     cors({
       origin: ENV.CORS_ORIGIN,   // ì˜ˆ: http://localhost:5173
       credentials: true,         // ì¿ í‚¤ ì „ì†¡ í—ˆìš© (í•µì‹¬)
     })
   );

   // 2) ì„¸ì…˜/ì¿ í‚¤: sameSite/secure ê°’ì€ ë„ë©”ì¸/í”„ë¡œí† ì½œ ì¡°í•©ì— ë§ì¶° ì¡°ì •
   app.use(
     session({
       name: 'sid',                       // ì„¸ì…˜ ì¿ í‚¤ ì´ë¦„
       secret: ENV.SESSION_SECRET,        // .envì—ì„œ ê´€ë¦¬
       resave: false,
       saveUninitialized: false,
       cookie: {
         httpOnly: true,                  // XSS ë°©ì§€ (í´ë¼ì´ì–¸íŠ¸ JSì—ì„œ ì ‘ê·¼ ë¶ˆê°€)
         sameSite: 'lax',                 // ì„œë¡œ ë‹¤ë¥¸ ë„ë©”ì¸/í¬íŠ¸ë¡œ í˜¸ì¶œí•˜ë©´ 'none' + secure í•„ìš”
         secure: ENV.NODE_ENV === 'production', // HTTPSì—ì„œë§Œ ì „ì†¡ (ê°œë°œì€ false)
         maxAge: 1000 * 60 * 60 * 24 * 7,       // 7ì¼
       },
     })
   );

   // 3) í”„ë¡ íŠ¸ì—”ë“œ(axios/fetch)ì—ì„œ ë°˜ë“œì‹œ withCredentials: true ì„¤ì •
   //    axios ì˜ˆì‹œ:
   //      axios.get('/auth/me', { withCredentials: true })
   //    fetch ì˜ˆì‹œ:
   //      fetch('/auth/me', { credentials: 'include' })

   // 4) Production í™˜ê²½(HTTPS, í”„ë¡ì‹œ)ì—ì„œì˜ ì¶”ê°€ íŒ
   //    - app.set('trust proxy', 1) ì‚¬ìš© ì‹œ, secure ì¿ í‚¤ ë° X-Forwarded-* í—¤ë” ì²˜ë¦¬ì— ë„ì›€
   //    - ì¿ í‚¤ ë„ë©”ì¸/ì„œë¸Œë„ë©”ì¸ ì •ì±…(ì˜ˆ: .example.com) í•„ìš” ì‹œ cookie.domain ì˜µì…˜ ê³ ë ¤
 */