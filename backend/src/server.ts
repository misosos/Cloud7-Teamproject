// src/server.ts
/**********************************************************************************
 * ì„œë²„ ì‹œì‘(bootstrap) íŒŒì¼ â€” ì• í”Œë¦¬ì¼€ì´ì…˜ì˜ ë‹¨ì¼ ì§„ì…ì 
 * ================================================================================
 * ì´ íŒŒì¼ì˜ ì—­í• (Responsibilities)
 *  1) .env í™˜ê²½ë³€ìˆ˜ ë¡œë“œ
 *  2) Express ì•±(app) ì¸ìŠ¤í„´ìŠ¤ë¥¼ ê°€ì ¸ì™€ HOST/PORTì—ì„œ ë¦¬ìŠ¨ ì‹œì‘
 *  3) ì„œë²„ ë ˆë²¨ ì—ëŸ¬(EADDRINUSE, EACCES ë“±) ì²˜ë¦¬
 *  4) í”„ë¡œì„¸ìŠ¤ ì¢…ë£Œ ì‹ í˜¸ ë° ì „ì—­ ì—ëŸ¬(uncaught/unhandled)ë¥¼ ê°ì§€í•˜ê³ 
 *     ì•ˆì „ ì¢…ë£Œ(shutdown)ë¥¼ ìˆ˜í–‰
 *
 * ì¤‘ìš” ì›ì¹™
 *  - ì´ íŒŒì¼ì—ì„œëŠ” "ì„œë²„ë¥¼ ì¼ ë‹¤/ë„ëŠ” ê²ƒ"ì—ë§Œ ì§‘ì¤‘í•©ë‹ˆë‹¤.
 *    (ë¯¸ë“¤ì›¨ì–´/ë¼ìš°íŒ…/ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ì€ ëª¨ë‘ app.ts ë° í•˜ìœ„ ëª¨ë“ˆì—ì„œ ì²˜ë¦¬)
 *  - ê¸°ëŠ¥ ì½”ë“œëŠ” ë‹¨ì¼ ë²„ì „ë§Œ ìœ ì§€í•©ë‹ˆë‹¤. (ì¤‘ë³µ ì„ ì–¸/ì¤‘ë³µ export ê¸ˆì§€)
 **********************************************************************************/

/* ==============================================================================
 *  í™˜ê²½ë³€ìˆ˜ ë¡œë“œ ë° ì•±/í™˜ê²½ ìœ í‹¸ import
 * =========================================================================== */

// â‘  .env ë‚´ìš©ì„ process.envì— ì£¼ì…
import 'dotenv/config';

// â‘¡ ë¯¸ë“¤ì›¨ì–´/ë¼ìš°íŒ…ì´ ì„¤ì •ëœ Express ì¸ìŠ¤í„´ìŠ¤
import app from './app';

// â‘¢ Zod ë“±ìœ¼ë¡œ ê²€ì¦ëœ í™˜ê²½ë³€ìˆ˜ ê°ì²´
import { env } from './utils/env';

/* ==============================================================================
 *  í˜¸ìŠ¤íŠ¸ / í¬íŠ¸ ê²°ì • ë¡œì§
 * =========================================================================== */
/**
 * HOST ê²°ì •
 *  - env ìŠ¤í‚¤ë§ˆì— HOSTê°€ ì—†ì„ ìˆ˜ ìˆìœ¼ë¯€ë¡œ, process.envë¥¼ ì§ì ‘ ì‚¬ìš©
 *  - ì•„ë¬´ ê°’ë„ ì—†ìœ¼ë©´ 'localhost'ë¡œ í´ë°±
 */
const HOST = (process.env.HOST ?? 'localhost').trim();

/**
 * PORT ê²°ì •
 *  - env.PORTëŠ” ë¬¸ìì—´ì´ë¯€ë¡œ, ìˆ«ìë¡œ ë³€í™˜í•˜ì—¬ ì‚¬ìš©
 *  - ìˆ«ìë¡œ ë³€í™˜í•  ìˆ˜ ì—†ê±°ë‚˜ 0 ì´í•˜ì´ë©´ ê¸°ë³¸ê°’ 3000 ì‚¬ìš©
 *  - 0.0.0.0 ì—ì„œ ë¦¬ìŠ¨í•˜ë©´ ì™¸ë¶€ ì ‘ê·¼ í—ˆìš© (ë„ì»¤/í´ë¼ìš°ë“œ ë°°í¬ì—ì„œ í”íˆ ì‚¬ìš©)
 */
const parsedPort = Number(env.PORT);
const PORT = Number.isFinite(parsedPort) && parsedPort > 0 ? parsedPort : 3000;

/* ==============================================================================
 *   ì„œë²„ ì‹œì‘ (app.listen)
 * =========================================================================== */
/**
 * ì„œë²„ ì‹œì‘
 *  - server ë³€ìˆ˜ëŠ” ë‹¨ í•œ ë²ˆë§Œ ì„ ì–¸ (ì¤‘ë³µ ì„ ì–¸/ì¤‘ë³µ export ë°©ì§€)
 *  - ì½˜ì†” ì¶œë ¥ ì‹œ 0.0.0.0 ì€ ê°œë°œì ì¹œí™”ì ìœ¼ë¡œ localhostë¡œ ë°”ê¿” ë³´ì—¬ì¤ë‹ˆë‹¤.
 */
const server = app.listen(PORT, HOST, () => {
  const visibleHost = HOST === '0.0.0.0' ? 'localhost' : HOST;
  console.log(`âœ… Backend running on http://${visibleHost}:${PORT}`);
});

/* ==============================================================================
 *  ì„œë²„ ì—ëŸ¬ í•¸ë“¤ë§
 * =========================================================================== */
/**
 * ì„œë²„ ì—ëŸ¬ í•¸ë“¤ë§
 *  - 'error' ì´ë²¤íŠ¸ëŠ” app.listen(...)ì—ì„œ ë°œìƒí•˜ëŠ” ë„¤íŠ¸ì›Œí¬ ë ˆë²¨ ì—ëŸ¬ë¥¼ ë‹¤ë£¹ë‹ˆë‹¤.
 *  - ëŒ€í‘œì ì¸ ì—ëŸ¬ ì½”ë“œ
 *    Â· EADDRINUSE: ì´ë¯¸ ì‚¬ìš© ì¤‘ì¸ í¬íŠ¸
 *    Â· EACCES    : ê¶Œí•œ ë¶€ì¡±(1024 ë¯¸ë§Œ í¬íŠ¸ ë“±)
 *    Â· ê¸°íƒ€      : ì›ë³¸ ì—ëŸ¬ ê°ì²´ ê·¸ëŒ€ë¡œ ë¡œê·¸ì— ì¶œë ¥
 *
 *  - ì—ëŸ¬ ë°œìƒ ì‹œ process.exitCodeë§Œ ì„¤ì •í•˜ê³ ,
 *    ì‹¤ì œ ì¢…ë£ŒëŠ” shutdown íë¦„ ë˜ëŠ” í”„ë¡œì„¸ìŠ¤ ì¢…ë£Œ ì‹œì ì—ì„œ ì´ ê°’ì„ ì°¸ê³ í•˜ë„ë¡ í•©ë‹ˆë‹¤.
 */
server.on('error', (err: NodeJS.ErrnoException) => {
  if (err.code === 'EADDRINUSE') {
    console.error(`âŒ Port ${PORT} is already in use`);
  } else if (err.code === 'EACCES') {
    console.error(`âŒ Need elevated privileges for port ${PORT}`);
  } else {
    console.error('âŒ Server error:', err);
  }

  // ì¢…ë£Œ ì½”ë“œë§Œ ì„¤ì •(ì‹¤ì œ ì¢…ë£ŒëŠ” ì•„ë˜ shutdown ë˜ëŠ” í”„ë¡œì„¸ìŠ¤ ì¢…ë£Œ ë£¨í‹´ì—ì„œ ì²˜ë¦¬)
  process.exitCode = 1;
});

/* ==============================================================================
 *  ì•ˆì „ ì¢…ë£Œ(shutdown) ìœ í‹¸ë¦¬í‹°
 * =========================================================================== */
/**
 * ì•ˆì „ ì¢…ë£Œ(shutdown)
 *  @param reason ì¢…ë£Œ ì‚¬ìœ (ì‹ í˜¸/ì˜ˆì™¸ ì¢…ë¥˜ ë“± í…ìŠ¤íŠ¸)
 *
 *  - server.close():
 *      Â· ê¸°ì¡´ì— ìˆ˜ë¦½ëœ ì—°ê²°ì„ ì •ìƒ ì¢…ë£Œí•œ ë’¤ ì½œë°±ì„ í˜¸ì¶œí•©ë‹ˆë‹¤.
 *      Â· ìƒˆ ì—°ê²°ì€ ë” ì´ìƒ ë°›ì§€ ì•ŠìŠµë‹ˆë‹¤.
 *  - ì˜ˆì™¸ ìƒí™©ì—ì„œë„ í”„ë¡œì„¸ìŠ¤ê°€ ì˜êµ¬ ì •ì§€í•˜ì§€ ì•Šë„ë¡ 5ì´ˆ íƒ€ì„ì•„ì›ƒì„ ë‘ê³ 
 *    ê°•ì œ ì¢…ë£Œë¥¼ ë³´ê°•í•©ë‹ˆë‹¤.
 */
function shutdown(reason: string) {
  console.log(`ğŸ›‘ Shutting down (${reason})`);

  try {
    // ê¸°ì¡´ ì—°ê²°ì„ ì •ìƒ ì¢…ë£Œ í›„, ì„¤ì •ëœ exitCodeë¡œ í”„ë¡œì„¸ìŠ¤ ì¢…ë£Œ
    server.close(() => process.exit(process.exitCode ?? 0));
  } catch (e) {
    // ì¢…ë£Œ ê³¼ì •ì—ì„œ ì—ëŸ¬ê°€ ë‚˜ë”ë¼ë„, ë¡œê·¸ë§Œ ë‚¨ê¸°ê³  ì¢…ë£Œë¥¼ ì§„í–‰
    console.error('âŒ Error during shutdown:', e);
    process.exit(process.exitCode ?? 1);
  }

  // í˜¹ì‹œ ëª¨ë¥¼ í•¸ë“¤ë§ ì§€ì—°/êµì°©ì„ ë°©ì§€í•˜ê¸° ìœ„í•œ ìµœí›„ì˜ ë°©ì–´ì„  (ìµœëŒ€ 5ì´ˆ í›„ ê°•ì œ ì¢…ë£Œ)
  setTimeout(() => process.exit(process.exitCode ?? 0), 5000);
}

/* ==============================================================================
 *   í”„ë¡œì„¸ìŠ¤ ë ˆë²¨ ì‹ í˜¸/ì˜ˆì™¸ ë°”ì¸ë”©
 * =========================================================================== */
/**
 * í”„ë¡œì„¸ìŠ¤ ì‹ í˜¸ ë° ì „ì—­ ì—ëŸ¬ ë°”ì¸ë”©
 *
 *  - SIGINT
 *      Â· í„°ë¯¸ë„ì—ì„œ Ctrl + C ì…ë ¥ ì‹œ ë°œìƒí•˜ëŠ” ì¸í„°ëŸ½íŠ¸ ì‹ í˜¸
 *      Â· ë³´í†µ ë¡œì»¬ ê°œë°œ í™˜ê²½ì—ì„œ ì„œë²„ë¥¼ ëŒ ë•Œ ë°œìƒ
 *
 *  - SIGTERM
 *      Â· ì»¨í…Œì´ë„ˆ/ì˜¤ì¼€ìŠ¤íŠ¸ë ˆì´í„°(ì˜ˆ: Docker, Kubernetes)ê°€
 *        "ì •ìƒ ì¢…ë£Œ"ë¥¼ ìš”ì²­í•  ë•Œ ë³´ë‚´ëŠ” ì‹ í˜¸
 *      Â· ì„œë²„ëŠ” ì´ë¥¼ ê°ì§€í•´ shutdown ë£¨í‹´ì„ ìˆ˜í–‰í•œ ë’¤ ì¢…ë£Œ
 *
 *  - uncaughtException
 *      Â· try/catchë¡œ ì¡ì§€ ëª»í•œ ë™ê¸° ì˜ˆì™¸
 *      Â· ì´ ìƒíƒœì—ì„œ ì„œë²„ë¥¼ ê³„ì† ëŒë¦¬ë©´ ìœ„í—˜í•˜ë¯€ë¡œ ë°˜ë“œì‹œ ë¡œê·¸ë¥¼ ë‚¨ê¸°ê³  ì¢…ë£Œ
 *
 *  - unhandledRejection
 *      Â· ì²˜ë¦¬ë˜ì§€ ì•Šì€ Promise ê±°ë¶€(rejection)
 *      Â· ë§ˆì°¬ê°€ì§€ë¡œ ë¡œê·¸ë¥¼ ë‚¨ê¸°ê³  ì•ˆì „ ì¢…ë£Œ ë£¨í‹´ìœ¼ë¡œ ìˆ˜ë ´
 *
 *  â–¶ ê³µí†µ ì •ì±…
 *    Â· ì–´ë–¤ ê²½ë¡œë¡œë“  ì „ì—­ ì—ëŸ¬/ì‹ í˜¸ê°€ ë“¤ì–´ì˜¤ë©´ ë°˜ë“œì‹œ shutdown()ì„ í˜¸ì¶œí•´ì„œ
 *      ë™ì¼í•œ ë°©ì‹ìœ¼ë¡œ ì„œë²„ë¥¼ ì¢…ë£Œí•©ë‹ˆë‹¤.
 */
process.on('SIGINT', () => shutdown('SIGINT'));
process.on('SIGTERM', () => shutdown('SIGTERM'));

process.on('uncaughtException', (err) => {
  console.error('uncaughtException:', err);
  shutdown('uncaughtException');
});

process.on('unhandledRejection', (reason) => {
  console.error('unhandledRejection:', reason);
  shutdown('unhandledRejection');
});

/* ==============================================================================
 *   default export
 * =========================================================================== */
/**
 * default export
 *  - í†µí•© í…ŒìŠ¤íŠ¸ ë“±ì—ì„œ server ì¸ìŠ¤í„´ìŠ¤ë¥¼ ì§ì ‘ ê°€ì ¸ì™€ close()í•  ë•Œ ìœ ìš©í•©ë‹ˆë‹¤.
 *    ì˜ˆ)
 *      import server from '../src/server';
 *      // í…ŒìŠ¤íŠ¸ ì¢…ë£Œ í›„
 *      server.close();
 */
export default server;