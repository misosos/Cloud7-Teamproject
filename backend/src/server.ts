// src/server.ts
/**
 * ì„œë²„ ì‹œì‘(bootstrap) íŒŒì¼ â€” ì• í”Œë¦¬ì¼€ì´ì…˜ì˜ ë‹¨ì¼ ì§„ì…ì 
 * ì±…ì„(Responsibilities)
 * 1) .env ë¡œë“œ
 * 2) Express ì•±(app) ê°€ì ¸ì™€ í¬íŠ¸/í˜¸ìŠ¤íŠ¸ì—ì„œ ë¦¬ìŠ¨
 * 3) ì„œë²„ ì—ëŸ¬ í•¸ë“¤ë§(EADDRINUSE/EACCES ë“±)
 * 4) í”„ë¡œì„¸ìŠ¤ ì¢…ë£Œ ì‹ í˜¸ ë° ì „ì—­ ì—ëŸ¬ ì²˜ë¦¬ â†’ ì•ˆì „ ì¢…ë£Œ(shutdown)
 *
 * âš ï¸ ê¸°ëŠ¥ ì½”ë“œëŠ” ë‹¨ì¼ ë²„ì „ë§Œ ìœ ì§€í•©ë‹ˆë‹¤(ì¤‘ë³µ ì„ ì–¸/ì¤‘ë³µ export ê¸ˆì§€).
 */

import 'dotenv/config';            // â‘  .env ë‚´ìš©ì„ process.envì— ì£¼ì…
import app from './app';           // â‘¡ ë¯¸ë“¤ì›¨ì–´/ë¼ìš°íŒ…ì´ ì„¤ì •ëœ Express ì¸ìŠ¤í„´ìŠ¤
import { env } from './utils/env'; // â‘¢ Zod ë“±ìœ¼ë¡œ ê²€ì¦ëœ í™˜ê²½ë³€ìˆ˜ ê°ì²´

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// í˜¸ìŠ¤íŠ¸/í¬íŠ¸ ê²°ì •
// - HOST: env ìŠ¤í‚¤ë§ˆì— ì—†ì„ ìˆ˜ ìˆìœ¼ë¯€ë¡œ process.env ì‚¬ìš©(ì—†ìœ¼ë©´ 'localhost')
// - PORT: env.PORT(ë¬¸ì) â†’ ìˆ«ì íŒŒì‹± ì‹¤íŒ¨ ì‹œ 3000 í´ë°±, 0 ì´í•˜ëŠ” ë¬´ì‹œ
//   - 0.0.0.0 ì—ì„œ ë¦¬ìŠ¨í•˜ë©´ ì™¸ë¶€ ì ‘ê·¼ í—ˆìš©(ë„ì»¤/í´ë¼ìš°ë“œ ë°°í¬ì— ì‚¬ìš©)
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const HOST = (process.env.HOST ?? 'localhost').trim();
const parsedPort = Number(env.PORT);
const PORT = Number.isFinite(parsedPort) && parsedPort > 0 ? parsedPort : 3000;

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// ì„œë²„ ì‹œì‘
// - ì¤‘ë³µ ì„ ì–¸/ì¤‘ë³µ export ë°©ì§€: server ë³€ìˆ˜ëŠ” ë‹¨ í•œ ë²ˆë§Œ ì„ ì–¸
// - ì½˜ì†” ì¶œë ¥ ì‹œ 0.0.0.0ì€ ê°œë°œì ì¹œí™”ì ìœ¼ë¡œ localhostë¡œ ëŒ€ì²´ í‘œê¸°
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const server = app.listen(PORT, HOST, () => {
  const visibleHost = HOST === '0.0.0.0' ? 'localhost' : HOST;
  console.log(`âœ… Backend running on http://${visibleHost}:${PORT}`);
});

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
/** ì„œë²„ ì—ëŸ¬ í•¸ë“¤ë§
 *  - EADDRINUSE: í¬íŠ¸ ì ìœ  ì¤‘
 *  - EACCES: ê¶Œí•œ ë¶€ì¡±(1024 ë¯¸ë§Œ í¬íŠ¸ ë“±)
 *  - ê¸°íƒ€: ì›ë³¸ ì—ëŸ¬ ë¡œê·¸ í›„ í”„ë¡œì„¸ìŠ¤ ì¢…ë£Œ ì½”ë“œ ì„¤ì •
 */
server.on('error', (err: NodeJS.ErrnoException) => {
  if (err.code === 'EADDRINUSE') {
    console.error(`âŒ Port ${PORT} is already in use`);
  } else if (err.code === 'EACCES') {
    console.error(`âŒ Need elevated privileges for port ${PORT}`);
  } else {
    console.error('âŒ Server error:', err);
  }
  process.exitCode = 1;
});

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
/** ì•ˆì „ ì¢…ë£Œ(shutdown) ìœ í‹¸ë¦¬í‹°
 *  @param reason ì¢…ë£Œ ì‚¬ìœ (ì‹ í˜¸/ì˜ˆì™¸ ì¢…ë¥˜)
 *  - server.close()ëŠ” ê¸°ì¡´ ì—°ê²°ì„ ì •ìƒ ì¢…ë£Œí•œ ë’¤ ì½œë°± í˜¸ì¶œ
 *  - ì˜ˆì™¸ ìƒí™©ì—ì„œë„ í”„ë¡œì„¸ìŠ¤ê°€ ì˜êµ¬ ì •ì§€í•˜ì§€ ì•Šë„ë¡ 5ì´ˆ íƒ€ì„ì•„ì›ƒ ë³´ê°•
 */
function shutdown(reason: string) {
  console.log(`ğŸ›‘ Shutting down (${reason})`);
  try {
    server.close(() => process.exit(process.exitCode ?? 0));
  } catch (e) {
    console.error('âŒ Error during shutdown:', e);
    process.exit(process.exitCode ?? 1);
  }
  // í˜¹ì‹œ ëª¨ë¥¼ í•¸ë“¤ë§ ì§€ì—° ë°©ì§€(ìµœëŒ€ 5ì´ˆ í›„ ê°•ì œ ì¢…ë£Œ)
  setTimeout(() => process.exit(process.exitCode ?? 0), 5000);
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// í”„ë¡œì„¸ìŠ¤ ë ˆë²¨ ì‹ í˜¸/ì˜ˆì™¸ ë°”ì¸ë”©
// - SIGINT : Ctrl+C
// - SIGTERM: ì»¨í…Œì´ë„ˆ/ì˜¤ì¼€ìŠ¤íŠ¸ë ˆì´í„°ì˜ ì •ìƒ ì¢…ë£Œ ì‹ í˜¸
// - uncaughtException/unhandledRejection: ì „ì—­ ë¯¸ì²˜ë¦¬ ì—ëŸ¬
//   â†’ ë°˜ë“œì‹œ ë¡œê·¸ ë‚¨ê¸°ê³  ì•ˆì „ ì¢…ë£Œ ë£¨í‹´ìœ¼ë¡œ ìˆ˜ë ´
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
process.on('SIGINT', () => shutdown('SIGINT'));
process.on('SIGTERM', () => shutdown('SIGTERM'));
process.on('uncaughtException', (err) => {
  console.error('uncaughtException:', err);
  shutdown('uncaughtException');
});
process.on('unhandledRejection', (reason) => {
  console.error('unhandledRejection:', reason);
  shutdown('unhandledRejection');
});

// default export
// - í†µí•© í…ŒìŠ¤íŠ¸ ë“±ì—ì„œ server ì¸ìŠ¤í„´ìŠ¤ë¥¼ ê°€ì ¸ì™€ ì§ì ‘ close()í•  ë•Œ ìœ ìš©
export default server;